<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard Input JP-ID</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Outfit', sans-serif;
            background-color: #0f0c29;
            background-image: 
                radial-gradient(at 0% 0%, hsla(253,16%,7%,1) 0, transparent 50%), 
                radial-gradient(at 50% 0%, hsla(225,39%,30%,1) 0, transparent 50%), 
                radial-gradient(at 100% 0%, hsla(339,49%,30%,1) 0, transparent 50%);
            min-height: 100vh;
            color: white;
        }
        .glass-panel {
            background: rgba(255, 255, 255, 0.05);
            backdrop-filter: blur(16px);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }
        .input-glass {
            background: rgba(0, 0, 0, 0.2);
            border: 1px solid rgba(255, 255, 255, 0.1);
            transition: all 0.3s ease;
        }
        .input-glass:focus {
            background: rgba(0, 0, 0, 0.4);
            border-color: #db2777;
            outline: none;
        }
        /* Animasi Card */
        @keyframes slideIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .queue-card { animation: slideIn 0.3s ease-out forwards; }
        
        .loader {
            width: 48px; height: 48px;
            border: 5px solid #FFF;
            border-bottom-color: #db2777;
            border-radius: 50%;
            display: inline-block;
            animation: rotation 1s linear infinite;
        }
        @keyframes rotation { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
</head>
<body class="p-4 md:p-8 flex justify-center items-start min-h-screen">

    <div class="glass-panel w-full max-w-6xl rounded-3xl overflow-hidden shadow-2xl relative flex flex-col lg:flex-row">
        
        <div class="w-full lg:w-7/12 p-6 md:p-8 border-b lg:border-b-0 lg:border-r border-white/10 relative">
            <h2 class="text-xl font-bold text-pink-400 mb-4 flex items-center gap-2">
                <span class="w-2 h-8 bg-pink-500 rounded-full"></span>
                INPUT DATA BARU
            </h2>

            <div class="mb-4">
                <textarea id="rawInput" rows="6" 
                    class="input-glass w-full rounded-xl p-4 text-sm text-gray-100 placeholder-gray-500 font-mono" 
                    placeholder="Paste chat disini... (Unboxing, Nama, Barang, dll)"></textarea>
            </div>

            <div class="grid grid-cols-2 gap-3 mb-4">
                <div class="col-span-1">
                    <label class="text-[10px] uppercase text-gray-400 tracking-wider">Kode</label>
                    <input type="text" id="pKode" class="input-glass w-full rounded-lg p-2 text-yellow-300 font-bold">
                </div>
                <div class="col-span-1">
                    <label class="text-[10px] uppercase text-gray-400 tracking-wider">Berat (Kg)</label>
                    <input type="text" id="pBerat" class="input-glass w-full rounded-lg p-2 text-green-300 font-bold">
                </div>
                <div class="col-span-2">
                    <label class="text-[10px] uppercase text-gray-400 tracking-wider">Nama</label>
                    <input type="text" id="pNama" class="input-glass w-full rounded-lg p-2 text-white font-semibold capitalize">
                </div>
                <div class="col-span-2">
                    <label class="text-[10px] uppercase text-gray-400 tracking-wider">Barang</label>
                    <textarea id="pBarang" rows="2" class="input-glass w-full rounded-lg p-2 text-sm text-gray-300"></textarea>
                </div>
            </div>

            <div class="mb-6">
                <label class="text-[10px] uppercase text-gray-400 tracking-wider mb-2 block">Foto (Max 10)</label>
                <div class="flex gap-4 items-start">
                    <label for="imageInput" class="cursor-pointer bg-white/5 border border-dashed border-gray-500 hover:border-pink-500 rounded-xl w-24 h-24 flex flex-col items-center justify-center transition text-gray-400 hover:text-pink-500">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"></path></svg>
                        <span class="text-[10px] mt-1">Pilih Foto</span>
                        <input id="imageInput" type="file" multiple accept="image/*" class="hidden" />
                    </label>
                    <div id="previewGallery" class="flex-1 flex gap-2 overflow-x-auto pb-2 h-24">
                        </div>
                </div>
            </div>

            <button onclick="addToQueue()" id="btnAdd" class="w-full bg-blue-600/80 hover:bg-blue-600 text-white font-bold py-3 px-4 rounded-xl shadow-lg border border-blue-400/30 transition flex justify-center items-center gap-2 group">
                <svg class="w-5 h-5 group-hover:rotate-90 transition-transform" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6"></path></svg>
                <span>+ TAMBAH KE ANTRIAN</span>
            </button>
        </div>

        <div class="w-full lg:w-5/12 bg-black/20 flex flex-col h-full min-h-[500px]">
            <div class="p-6 border-b border-white/10 flex justify-between items-center bg-white/5">
                <h3 class="text-lg font-bold text-white">Daftar Antrian</h3>
                <span id="queueCount" class="bg-pink-600 text-white text-xs font-bold px-2 py-1 rounded-md">0 Item</span>
            </div>
            
            <div id="queueContainer" class="flex-1 p-6 overflow-y-auto space-y-4">
                <div id="emptyState" class="text-center text-gray-500 py-10 opacity-50">
                    <svg class="w-16 h-16 mx-auto mb-3" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M19 11H5m14 0a2 2 0 012 2v6a2 2 0 01-2 2H5a2 2 0 01-2-2v-6a2 2 0 012-2m14 0V9a2 2 0 00-2-2M5 11V9a2 2 0 012-2m0 0V5a2 2 0 012-2h6a2 2 0 012 2v2M7 7h10"></path></svg>
                    <p>Belum ada data di antrian</p>
                </div>
                </div>

            <div class="p-6 border-t border-white/10 bg-black/40 backdrop-blur-md">
                <button onclick="submitBatch()" id="btnFinalSubmit" class="w-full bg-gradient-to-r from-pink-600 to-purple-600 text-white font-bold py-4 px-6 rounded-xl shadow-lg opacity-50 cursor-not-allowed transition hover:scale-[1.02]" disabled>
                    KIRIM SEMUA DATA
                </button>
            </div>
        </div>

    </div>

    <div id="loading" class="hidden fixed inset-0 bg-black/90 backdrop-blur-md flex flex-col items-center justify-center z-50">
        <span class="loader mb-4"></span>
        <h3 class="text-xl font-bold text-white">Mengirim ke Spreadsheet...</h3>
        <p id="loadingText" class="text-sm text-gray-400 mt-2">Mohon tunggu, jangan tutup halaman.</p>
    </div>

    <script>
        let uploadQueue = []; // Array penyimpanan sementara

        // --- 1. SMART PARSER (Sama seperti sebelumnya) ---
        const rawInput = document.getElementById('rawInput');
        rawInput.addEventListener('input', function() {
            let text = this.value;
            const weightRegex = /(\d+[\.,]?\d*)\s*(kg|gram|ons)/i;
            const weightMatch = text.match(weightRegex);
            let weight = weightMatch ? weightMatch[0] : "";
            let cleanText = text.replace(weightRegex, ""); 

            let code = "";
            const codeLabelMatch = cleanText.match(/(?:kode|code)\s*[:=]?\s*([a-zA-Z0-9]+)/i);
            if (codeLabelMatch) {
                code = codeLabelMatch[1];
                cleanText = cleanText.replace(codeLabelMatch[0], ""); 
            } else {
                const digitMatch = cleanText.match(/\b\d{1,5}\b/);
                if(digitMatch) {
                    code = digitMatch[0];
                    cleanText = cleanText.replace(digitMatch[0], ""); 
                }
            }

            cleanText = cleanText
                .replace(/unboxing.*?(\n|$)/yi, "\n")
                .replace(/tgl\s*\d+/yi, "")
                .replace(/[0-9]+\s+(jan|feb|mar|apr)[a-z]*/yi, "");

            let name = "";
            let goods = "";
            let lines = cleanText.split('\n').map(l => l.trim()).filter(l => l !== "");

            const explicitNameIndex = lines.findIndex(l => l.match(/^(nama|name)\s*[:=]/i));
            if (explicitNameIndex !== -1) {
                name = lines[explicitNameIndex].replace(/^(nama|name)\s*[:=]\s*/i, "");
                lines.splice(explicitNameIndex, 1);
                goods = lines.join(", ");
            } else {
                let nameFound = false;
                let goodsArray = [];
                for (let i = 0; i < lines.length; i++) {
                    let line = lines[i];
                    if (!nameFound && line.length < 35 && !line.includes(",") && !line.match(/^(barang|item)/i)) {
                        name = line;
                        nameFound = true;
                    } else {
                        goodsArray.push(line.replace(/^(barang|item|isi)\s*[:=]\s*/i, ""));
                    }
                }
                goods = goodsArray.join(", ");
            }

            document.getElementById('pBerat').value = weight;
            document.getElementById('pNama').value = name;
            document.getElementById('pKode').value = code;
            document.getElementById('pBarang').value = goods;
        });

        // --- 2. IMAGE PREVIEW ---
        const imageInput = document.getElementById('imageInput');
        imageInput.addEventListener('change', function() {
            const gallery = document.getElementById('previewGallery');
            gallery.innerHTML = "";
            Array.from(this.files).forEach(file => {
                const img = document.createElement('img');
                img.src = URL.createObjectURL(file);
                img.className = "h-full w-24 object-cover rounded-lg border border-white/20";
                gallery.appendChild(img);
            });
        });

        // --- 3. ADD TO QUEUE LOGIC ---
        async function addToQueue() {
            const btn = document.getElementById('btnAdd');
            const originalText = "<span>+ TAMBAH KE ANTRIAN</span>"; // Simpan teks asli
            
            // Ambil Data Form
            const nama = document.getElementById('pNama').value;
            const kode = document.getElementById('pKode').value;
            const barang = document.getElementById('pBarang').value;
            const berat = document.getElementById('pBerat').value;
            
            // Validasi
            if(!nama && !kode) { 
                alert("Mohon isi Nama atau Kode terlebih dahulu."); 
                return; 
            }

            // --- MULAI PROSES (SAFE MODE) ---
            try {
                // 1. Ubah Status Tombol jadi Loading
                btn.innerHTML = `<span class="loader" style="width: 20px; height: 20px; border-width: 2px;"></span> Memproses...`;
                btn.disabled = true;
                btn.classList.add('opacity-75', 'cursor-wait');

                // 2. Proses Kompresi Gambar
                let processedImages = [];
                const files = document.getElementById('imageInput').files;
                
                if (files.length > 0) {
                    for (let i = 0; i < Math.min(files.length, 10); i++) {
                        try {
                            // Kita bungkus kompresi per file agar jika 1 gagal, yang lain tetap jalan
                            const base64 = await compressImage(files[i]);
                            processedImages.push(base64);
                        } catch (err) {
                            console.error("Gagal kompres file ke-" + i, err);
                        }
                    }
                }

                // 3. Tambah ke Array Antrian
                uploadQueue.push({
                    id: Date.now(),
                    nama: nama || "-", // Default strip jika kosong
                    kode: kode || "-",
                    barang: barang || "-",
                    berat: berat || "-",
                    images: processedImages,
                    imageCount: processedImages.length
                });

                // 4. Render Ulang & Reset
                renderQueue();
                resetInputForm();

            } catch (error) {
                // Jika ada error fatal, munculkan alert
                console.error(error);
                alert("Terjadi kesalahan saat memproses data: " + error.message);
                
            } finally {
                // --- BAGIAN PENTING: FINALLY ---
                // Kode di sini PASTI dieksekusi walau error sekalipun
                // Kembalikan tombol ke kondisi semula
                btn.innerHTML = `
                    <svg class="w-5 h-5 group-hover:rotate-90 transition-transform" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6"></path></svg>
                    <span>+ TAMBAH KE ANTRIAN</span>
                `;
                btn.disabled = false;
                btn.classList.remove('opacity-75', 'cursor-wait');
            }
        }

        function renderQueue() {
            const container = document.getElementById('queueContainer');
            const emptyState = document.getElementById('emptyState');
            const btnFinal = document.getElementById('btnFinalSubmit');
            const countLabel = document.getElementById('queueCount');

            // --- SAFETY CHECK (PENTING) ---
            // Jika elemen HTML belum diupdate, hentikan fungsi agar tidak error
            if (!container || !emptyState || !btnFinal) {
                console.warn("Elemen Antrian tidak ditemukan. Pastikan Anda menggunakan HTML versi Batch Dashboard.");
                return; 
            }

            // Toggle Empty State
            if (uploadQueue.length === 0) {
                emptyState.style.display = 'block'; // Di sini letak error sebelumnya
                btnFinal.disabled = true;
                btnFinal.classList.add('opacity-50', 'cursor-not-allowed');
                
                // Bersihkan container tapi biarkan emptyState di dalamnya
                // Cara aman: sembunyikan semua anak kecuali emptyState
                Array.from(container.children).forEach(child => {
                    if (child.id !== 'emptyState') child.remove();
                });
            } else {
                emptyState.style.display = 'none'; // Atau di sini
                btnFinal.disabled = false;
                btnFinal.classList.remove('opacity-50', 'cursor-not-allowed');
                
                // Re-render list
                // Hapus semua kartu KECUALI emptyState
                Array.from(container.children).forEach(child => {
                    if (child.id !== 'emptyState') child.remove();
                });

                // Masukkan kartu antrian baru
                uploadQueue.forEach((item, index) => {
                    const card = document.createElement('div');
                    card.className = "queue-card bg-white/5 border border-white/10 p-4 rounded-xl flex justify-between items-start mb-2"; // Tambah mb-2
                    card.innerHTML = `
                        <div>
                            <div class="flex items-center gap-2 mb-1">
                                <span class="text-xs font-bold text-pink-400">#${index + 1}</span>
                                <h4 class="font-bold text-white">${item.nama || "Tanpa Nama"}</h4>
                            </div>
                            <p class="text-xs text-gray-400">Kode: <span class="text-yellow-300">${item.kode}</span> | Berat: <span class="text-green-300">${item.berat}</span></p>
                            <p class="text-xs text-gray-500 mt-1">${item.imageCount} Foto terlampir</p>
                        </div>
                        <button onclick="removeFromQueue(${item.id})" class="text-gray-500 hover:text-red-500 transition p-2">
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path></svg>
                        </button>
                    `;
                    container.appendChild(card);
                });
            }
            
            if(countLabel) countLabel.innerText = uploadQueue.length + " Item";
        }

        function removeFromQueue(id) {
            uploadQueue = uploadQueue.filter(item => item.id !== id);
            renderQueue();
        }

        function resetInputForm() {
            rawInput.value = "";
            document.getElementById('pNama').value = "";
            document.getElementById('pKode').value = "";
            document.getElementById('pBarang').value = "";
            document.getElementById('pBerat').value = "";
            document.getElementById('imageInput').value = "";
            document.getElementById('previewGallery').innerHTML = "";
        }

        // --- 4. BATCH SUBMIT ENGINE ---
        async function submitBatch() {
            if (uploadQueue.length === 0) return;

            const loading = document.getElementById('loading');
            const loadingText = document.getElementById('loadingText');
            loading.classList.remove('hidden');
            loadingText.innerText = `Sedang mengupload ${uploadQueue.length} data paket...`;

            try {
                // --- GANTI URL APPSCRIPT DI SINI ---
                const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbwc79IQd3Fs6UiHVG-lkcLYUJ6PHygvY9jR2BgHCB7FEdy2Y-lfFdklLgb3VGIncDBI6w/exec"; 

                const payload = { entries: uploadQueue };

                await fetch(SCRIPT_URL, {
                    method: 'POST',
                    mode: 'no-cors',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                alert("✅ SEMUA DATA BERHASIL DIKIRIM!");
                uploadQueue = []; // Kosongkan antrian
                renderQueue();

            } catch (error) {
                alert("❌ Terjadi kesalahan: " + error);
            } finally {
                loading.classList.add('hidden');
            }
        }

        // --- UTILS ---
        function compressImage(file) {
            return new Promise((resolve, reject) => {
                // Cek apakah file benar-benar gambar
                if (!file.type.match(/image.*/)) {
                    reject(new Error("File bukan gambar"));
                    return;
                }

                const reader = new FileReader();
                reader.readAsDataURL(file);
                
                // Handler jika pembacaan file sukses
                reader.onload = (event) => {
                    const img = new Image();
                    img.src = event.target.result;
                    
                    // Handler jika gambar sukses dimuat di memori
                    img.onload = () => {
                        const canvas = document.createElement('canvas');
                        const ctx = canvas.getContext('2d');
                        
                        // Resize Logic
                        const MAX_WIDTH = 1000;
                        let width = img.width;
                        let height = img.height;

                        if (width > MAX_WIDTH) {
                            height *= MAX_WIDTH / width;
                            width = MAX_WIDTH;
                        }

                        canvas.width = width;
                        canvas.height = height;
                        
                        // Gambar ke canvas
                        ctx.drawImage(img, 0, 0, width, height);
                        
                        // Convert ke JPG kompresi 0.7
                        resolve(canvas.toDataURL('image/jpeg', 0.7));
                    };

                    // Handler jika gambar corrupt/rusak
                    img.onerror = (error) => reject(error);
                };

                // Handler jika FileReader gagal
                reader.onerror = (error) => reject(error);
            });
        }
    </script>
</body>
</html>
